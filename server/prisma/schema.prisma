generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(uuid())
  username          String             @unique
  email             String             @unique
  passwordHash      String             @map("password_hash")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  xp                Int                @default(0)
  level             Int                @default(1)
  darkMatter        Float              @default(0) @map("dark_matter")
  credits           Float              @default(0) @map("credits")
  coalitionId       String?            @map("coalition_id")
  coalitionRole     String             @default("MEMBER") @map("coalition_role")
  lastActiveAt      DateTime?          @map("last_active_at")
  admiral           Admiral?
  sentInvites       CoalitionInvite[]  @relation("SentInvites")
  receivedInvites   CoalitionInvite[]  @relation("ReceivedInvites")
  coalitionMessages CoalitionMessage[]
  receivedDMs       DirectMessage[]    @relation("ReceivedDMs")
  sentDMs           DirectMessage[]    @relation("SentDMs")
  espionageReports  EspionageReport[]
  fleets            Fleet[]
  gearPieces        GearPiece[]
  inboxMessages     InboxMessage[]
  planets           Planet[]
  reconProbes       ReconProbe[]
  capitalShips      CapitalShip[]      @relation("UserCapitalShips")
  coalition         Coalition?         @relation(fields: [coalitionId], references: [id])

  @@map("users")
}

model Coalition {
  id          String             @id @default(uuid())
  name        String             @unique
  tag         String             @unique
  description String?
  founderId   String             @map("founder_id")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  isLocked    Boolean            @default(false) @map("is_locked")
  invites     CoalitionInvite[]
  messages    CoalitionMessage[]
  members     User[]

  @@map("coalitions")
}

model CoalitionMessage {
  id          String    @id @default(uuid())
  coalitionId String    @map("coalition_id")
  userId      String    @map("user_id")
  content     String
  createdAt   DateTime  @default(now()) @map("created_at")
  coalition   Coalition @relation(fields: [coalitionId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("coalition_messages")
}

model CoalitionInvite {
  id          String    @id @default(uuid())
  coalitionId String    @map("coalition_id")
  userId      String    @map("user_id")
  senderId    String    @map("sender_id")
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now()) @map("created_at")
  coalition   Coalition @relation(fields: [coalitionId], references: [id], onDelete: Cascade)
  sender      User      @relation("SentInvites", fields: [senderId], references: [id], onDelete: Cascade)
  user        User      @relation("ReceivedInvites", fields: [userId], references: [id], onDelete: Cascade)

  @@map("coalition_invites")
}

model DirectMessage {
  id         String   @id @default(uuid())
  senderId   String   @map("sender_id")
  receiverId String   @map("receiver_id")
  content    String
  isRead     Boolean  @default(false) @map("is_read")
  createdAt  DateTime @default(now()) @map("created_at")
  receiver   User     @relation("ReceivedDMs", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User     @relation("SentDMs", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId, createdAt])
  @@index([receiverId, isRead])
  @@map("direct_messages")
}

model Planet {
  id                      String          @id @default(uuid())
  ownerId                 String          @map("owner_user_id")
  x                       Int
  y                       Int
  name                    String
  carbon                  Float           @default(500)
  titanium                Float           @default(500)
  food                    Float           @default(500)
  credits                 Float           @default(100)
  stability               Int             @default(0)
  taxRate                 Int             @default(10)
  population              Int             @default(100)
  isNpc                   Boolean         @default(false) @map("is_npc")
  npcLevel                Int             @default(0) @map("npc_level")
  npcClass                String?         @map("npc_class")
  attackCount             Int             @default(0) @map("attack_count")
  maxAttacks              Int             @default(15) @map("max_attacks")
  npcLootGearId           String?         @map("npc_loot_gear_id")
  npcRespawnCount         Int             @default(0) @map("npc_respawn_count")
  lastResourceUpdate      DateTime        @default(now()) @map("last_resource_update")
  lastFoodConsumption     DateTime        @default(now()) @map("last_food_consumption")
  spyCount                Int             @default(0) @map("spy_count")
  gridSizeX               Int             @default(10) @map("grid_size_x")
  gridSizeY               Int             @default(10) @map("grid_size_y")
  defenseTurretsJson      String?         @map("defense_turrets_json")
  isBuilding              Boolean         @default(false) @map("is_building")
  activeBuildId           String?         @map("active_build_id")
  buildFinishTime         DateTime?       @map("build_finish_time")
  recruitmentQueue        String?         @map("recruitment_queue")
  manufacturingQueue      String?         @map("manufacturing_queue")
  turretConstructionQueue String?         @map("turret_construction_queue")
  energyCanopyLevel       Int             @default(0) @map("energy_canopy_level")
  orbitalMinefieldLevel   Int             @default(0) @map("orbital_minefield_level")
  dockingHubLevel         Int             @default(0) @map("docking_hub_level")
  createdAt               DateTime        @default(now()) @map("created_at")
  updatedAt               DateTime        @updatedAt @map("updated_at")
  darkMatter              Float           @default(0) @map("dark_matter")
  planetType              String          @default("colony") @map("planet_type")
  stationedAdmiral        Admiral?        @relation("StationedAdmiral")
  buildings               Building[]
  defenseLayout           DefenseLayout?
  fleetsFrom              Fleet[]         @relation("FromPlanet")
  fleetsTo                Fleet[]         @relation("ToPlanet")
  units                   PlanetUnit[]
  owner                   User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  reconProbesLaunched     ReconProbe[]    @relation("ProbesLaunched")
  tools                   ToolInventory[]
  capitalShips            CapitalShip[]   @relation("PlanetCapitalShips")

  @@unique([x, y])
  @@index([ownerId])
  @@map("planets")
}

model PlanetUnit {
  id        String   @id @default(uuid())
  planetId  String   @map("planet_id")
  unitType  String   @map("unit_type")
  count     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  planet    Planet   @relation(fields: [planetId], references: [id], onDelete: Cascade)

  @@unique([planetId, unitType])
  @@map("planet_units")
}

model ToolInventory {
  id        String   @id @default(uuid())
  planetId  String   @map("planet_id")
  toolType  String   @map("tool_type")
  count     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  planet    Planet   @relation(fields: [planetId], references: [id], onDelete: Cascade)

  @@unique([planetId, toolType])
  @@map("tool_inventories")
}

model DefenseLayout {
  id            String   @id @default(uuid())
  planetId      String   @unique @map("planet_id")
  frontLaneJson String   @map("front_lane_json")
  leftLaneJson  String   @map("left_lane_json")
  rightLaneJson String   @map("right_lane_json")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  planet        Planet   @relation(fields: [planetId], references: [id], onDelete: Cascade)

  @@map("defense_layouts")
}

model Admiral {
  id                   String   @id @default(uuid())
  userId               String   @unique @map("user_id")
  name                 String   @default("Admiral")
  gearJson             String   @default("{}") @map("gear_json")
  meleeStrengthBonus   Int      @default(0) @map("melee_strength_bonus")
  rangedStrengthBonus  Int      @default(0) @map("ranged_strength_bonus")
  canopyReductionBonus Int      @default(0) @map("canopy_reduction_bonus")
  attackBonus          Int      @default(0) @map("attack_bonus")
  defenseBonus         Int      @default(0) @map("defense_bonus")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  stationedPlanetId    String?  @unique @map("stationed_planet_id")
  stationedPlanet      Planet?  @relation("StationedAdmiral", fields: [stationedPlanetId], references: [id])
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fleets               Fleet[]

  @@map("admirals")
}

model GearPiece {
  id                   String   @id @default(uuid())
  userId               String   @map("user_id")
  slotType             String   @map("slot_type")
  name                 String
  rarity               String
  level                Int      @default(1)
  meleeStrengthBonus   Int      @default(0) @map("melee_strength_bonus")
  rangedStrengthBonus  Int      @default(0) @map("ranged_strength_bonus")
  canopyReductionBonus Int      @default(0) @map("canopy_reduction_bonus")
  attackBonus          Int      @default(0) @map("attack_bonus")
  defenseBonus         Int      @default(0) @map("defense_bonus")
  setName              String?  @map("set_name")
  iconName             String?  @map("icon_name")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("gear_pieces")
}

model BattleReport {
  id                      String   @id @default(uuid())
  fleetId                 String   @unique @map("fleet_id")
  attackerId              String   @map("attacker_user_id")
  defenderId              String   @map("defender_user_id")
  attackerPlanetId        String   @map("attacker_planet_id")
  defenderPlanetId        String   @map("defender_planet_id")
  winner                  String
  laneResultsJson         String   @map("lane_results_json")
  attackerTotalLossesJson String   @map("attacker_total_losses_json")
  defenderTotalLossesJson String   @map("defender_total_losses_json")
  resourcesJson           String?  @map("resources_json")
  createdAt               DateTime @default(now()) @map("created_at")
  fleet                   Fleet    @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  @@map("battle_reports")
}

model Fleet {
  id                      String        @id @default(uuid())
  ownerId                 String        @map("owner_user_id")
  fromPlanetId            String?       @map("from_planet_id")
  fromCapitalShipId       String?       @map("from_capital_ship_id")
  toPlanetId              String?       @map("to_planet_id")
  toCapitalShipId         String?       @map("to_capital_ship_id")
  type                    String
  unitsJson               String        @map("units_json")
  laneAssignmentsJson     String?       @map("lane_assignments_json")
  toolsJson               String?       @map("tools_json")
  cargoJson               String?       @map("cargo_json")
  borrowedFromDefenseJson String?       @map("borrowed_from_defense_json")
  admiralId               String?       @map("admiral_id")
  departAt                DateTime      @default(now()) @map("depart_at")
  arriveAt                DateTime      @map("arrive_at")
  status                  String        @default("enroute")
  createdAt               DateTime      @default(now()) @map("created_at")
  updatedAt               DateTime      @updatedAt @map("updated_at")
  targetEventShipId       String?       @map("target_event_ship_id")
  battleReport            BattleReport?
  admiral                 Admiral?      @relation(fields: [admiralId], references: [id])
  fromPlanet              Planet?       @relation("FromPlanet", fields: [fromPlanetId], references: [id])
  fromCapitalShip         CapitalShip?  @relation("FleetFromCapitalShip", fields: [fromCapitalShipId], references: [id])
  owner                   User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  toPlanet                Planet?       @relation("ToPlanet", fields: [toPlanetId], references: [id])
  toCapitalShip           CapitalShip?  @relation("FleetToCapitalShip", fields: [toCapitalShipId], references: [id])

  @@index([status, arriveAt])
  @@index([ownerId, status])
  @@index([toPlanetId, status])
  @@index([toCapitalShipId, status])
  @@map("fleets")
}

model Building {
  id       String @id @default(uuid())
  planetId String @map("planet_id")
  type     String
  x        Int
  y        Int
  level    Int    @default(1)
  status   String @default("active")
  planet   Planet @relation(fields: [planetId], references: [id], onDelete: Cascade)

  @@map("buildings")
}

model ReconProbe {
  id              String    @id @default(uuid())
  type            String    @default("recon_probe")
  ownerId         String    @map("owner_user_id")
  fromPlanetId    String    @map("from_planet_id")
  targetX         Int       @map("target_x")
  targetY         Int       @map("target_y")
  status          String    @default("traveling")
  startTime       DateTime  @default(now()) @map("start_time")
  arrivalTime     DateTime  @map("arrival_time")
  returnTime      DateTime? @map("return_time")
  cooldownUntil   DateTime? @map("cooldown_until")
  wasDiscovered   Boolean   @default(false) @map("was_discovered")
  lastUpdateTime  DateTime  @default(now()) @map("last_update_time")
  discoveryChance Float     @default(0) @map("discovery_chance")
  accuracy        Float     @default(0) @map("accuracy")
  radius          Int       @default(150)
  fromPlanet      Planet    @relation("ProbesLaunched", fields: [fromPlanetId], references: [id])
  owner           User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("recon_probes")
}

model EspionageReport {
  id        String   @id @default(uuid())
  ownerId   String   @map("owner_user_id")
  probeId   String?  @map("probe_id")
  probeType String   @map("probe_type")
  targetX   Int      @map("target_x")
  targetY   Int      @map("target_y")
  accuracy  Float    @default(0)
  dataJson  String   @map("data_json")
  createdAt DateTime @default(now()) @map("created_at")
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("espionage_reports")
}

model InboxMessage {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  content   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("inbox_messages")
}

model WorldConfig {
  id             String    @id @default("singleton")
  sizeX          Int       @default(10000) @map("size_x")
  sizeY          Int       @default(10000) @map("size_y")
  expansionCount Int       @default(0) @map("expansion_count")
  lastExpansion  DateTime? @map("last_expansion")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("world_config")
}

model BlackHole {
  id        String   @id @default(uuid())
  x         Int
  y         Int
  radius    Int      @default(300)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([x, y])
  @@map("black_holes")
}

// =============================================================================
// CAPITAL SHIPS
// =============================================================================

model CapitalShip {
  id              String    @id @default(cuid())
  ownerId         String    @map("owner_user_id")
  owner           User      @relation("UserCapitalShips", fields: [ownerId], references: [id])
  fromPlanetId    String    @map("from_planet_id")
  fromPlanet      Planet    @relation("PlanetCapitalShips", fields: [fromPlanetId], references: [id])
  
  // Status: constructing, ready, traveling, deployed, returning, damaged, repairing
  status          String    @default("constructing")
  
  // Current position (null when docked)
  x               Int?
  y               Int?
  
  // Deployment commitment
  commitmentDays  Int?      @map("commitment_days")
  deployedAt      DateTime? @map("deployed_at")
  deployedUntil   DateTime? @map("deployed_until")
  
  // Travel
  targetX         Int?      @map("target_x")
  targetY         Int?      @map("target_y")
  arrivalTime     DateTime? @map("arrival_time")
  travelStartedAt DateTime? @map("travel_started_at")
  
  // Combat stats
  currentHp       Int       @default(0) @map("current_hp")
  maxHp           Int       @default(1000) @map("max_hp")
  garrison        Json?     // Allied units stationed on the capital ship
  
  // Construction/Repair progress (JSON: { required, donated, phase, totalPhases, isRepair })
  buildProgress   Json?     @map("build_progress")
  
  // Destruction cooldown
  cooldownUntil   DateTime? @map("cooldown_until")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Fleets launched from this capital ship
  fleetsFrom      Fleet[]   @relation("FleetFromCapitalShip")
  // Fleets targeting this capital ship
  fleetsTo        Fleet[]   @relation("FleetToCapitalShip")
  
  @@index([ownerId, status])
  @@index([status])
  @@map("capital_ships")
}

// =============================================================================
// WORLD EVENTS (Alien Invasion, etc.)
// =============================================================================

model WorldEvent {
  id              String    @id @default(cuid())
  type            String    // e.g., "alien_invasion"
  name            String
  status          String    @default("scheduled") // scheduled, active, retaliation, ended
  startTime       DateTime  @map("start_time")
  endTime         DateTime  @map("end_time")
  retaliationTime DateTime? @map("retaliation_time")
  config          Json?     // Event-specific configuration
  globalState     Json?     @map("global_state") // Shared state (mothership HP, portal location, etc.)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  ships           EventShip[]
  scores          EventScore[]
  heatTrackers    EventHeat[]
  retaliations    EventRetaliation[]
  bossDamages     EventBossDamage[]

  @@index([status])
  @@map("world_events")
}

model EventShip {
  id                String    @id @default(cuid())
  eventId           String    @map("event_id")
  event             WorldEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  shipType          String    @map("ship_type") // scout, raider, carrier, dreadnought, mothership
  tier              Int       @default(1)
  level             Int       @default(1)
  name              String
  
  zoneType          String    @map("zone_type") // portal, player_ring
  ownerUserId       String?   @map("owner_user_id") // For player_ring ships
  
  x                 Int
  y                 Int
  distanceFromOwner Int?      @map("distance_from_owner")
  
  // Combat state
  garrison          Json?     // Units defending the ship
  currentHp         Int?      @map("current_hp") // For persistent HP ships like mothership
  maxHp             Int?      @map("max_hp")
  attackCount       Int       @default(0) @map("attack_count")
  maxAttacks        Int       @default(10) @map("max_attacks")
  
  // Defeat/respawn
  isDefeated        Boolean   @default(false) @map("is_defeated")
  respawnAt         DateTime? @map("respawn_at")
  
  // Loot configuration
  lootConfig        Json?     @map("loot_config")
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  bossDamages       EventBossDamage[]

  @@index([eventId, zoneType])
  @@index([eventId, ownerUserId])
  @@index([eventId, isDefeated])
  @@map("event_ships")
}

model EventScore {
  id              String    @id @default(cuid())
  eventId         String    @map("event_id")
  event           WorldEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId          String    @map("user_id")
  coalitionId     String?   @map("coalition_id")
  
  xenoCores       Int       @default(0) @map("xeno_cores")
  shipsDefeated   Int       @default(0) @map("ships_defeated")
  damageDealt     Int       @default(0) @map("damage_dealt")
  attacksLaunched Int       @default(0) @map("attacks_launched")
  defensesWon     Int       @default(0) @map("defenses_won")
  defensesLost    Int       @default(0) @map("defenses_lost")
  
  claimedRewards  Json?     @map("claimed_rewards") // End-of-event rewards
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([eventId, userId], name: "eventId_userId")
  @@index([eventId, xenoCores])
  @@index([eventId, coalitionId])
  @@map("event_scores")
}

model EventHeat {
  id                   String    @id @default(cuid())
  eventId              String    @map("event_id")
  event                WorldEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId               String    @map("user_id")
  
  currentHeat          Int       @default(0) @map("current_heat")
  peakHeat             Int       @default(0) @map("peak_heat")
  lastHeatGain         DateTime? @map("last_heat_gain")
  lastRetaliation      DateTime? @map("last_retaliation")
  retaliationsReceived Int       @default(0) @map("retaliations_received")
  
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  @@unique([eventId, userId], name: "eventId_userId")
  @@index([eventId, currentHeat])
  @@map("event_heat")
}

model EventRetaliation {
  id             String    @id @default(cuid())
  eventId        String    @map("event_id")
  event          WorldEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  targetUserId   String    @map("target_user_id")
  targetPlanetId String    @map("target_planet_id")
  
  waveType       String    @map("wave_type") // random, final_swarm
  tier           Int       @default(1)
  status         String    @default("incoming") // incoming, resolved, cancelled
  outcome        String?   // defended, breached, target_missing
  
  scheduledAt    DateTime  @map("scheduled_at")
  arriveAt       DateTime  @map("arrive_at")
  
  lootTaken      Json?     @map("loot_taken") // Resources/units lost if breached
  
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([eventId, targetUserId])
  @@index([eventId, status])
  @@map("event_retaliations")
}

model EventBossDamage {
  id            String    @id @default(cuid())
  eventId       String    @map("event_id")
  event         WorldEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  bossShipId    String    @map("boss_ship_id")
  bossShip      EventShip  @relation(fields: [bossShipId], references: [id], onDelete: Cascade)
  userId        String    @map("user_id")
  coalitionId   String?   @map("coalition_id")
  
  damageDealt   Int       @default(0) @map("damage_dealt")
  attacksLanded Int       @default(0) @map("attacks_landed")
  wasKillingBlow Boolean  @default(false) @map("was_killing_blow")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@unique([eventId, bossShipId, userId], name: "eventId_bossShipId_userId")
  @@index([eventId, bossShipId])
  @@map("event_boss_damages")
}
